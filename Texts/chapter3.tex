% !TEX root = ../thesis.tex

\todo{Here we shall summarize what this chapter is about}

\section{General idea}

\todo{In thermal equilibrium}

Diagrammatic Monte Carlo (from here on abbreviated DMC) is a numerical method developed by Prokof'ev et al. \cite{MishchenkoA.2000DqMC} in order to calculate quantities $ Q(\{ y \}) $, given in terms of a series of integrals with an ever increasing number of integration variables
\begin{equation}
	\label{eq:integralSeries}
	Q(\{ y \})
	= \sum_{n=0}^\infty \sum_{\xi_n} \int \diff x_1 \dots \diff x_n \, D_n(\xi_n, \, \{y\}, \, x_1, \, \dots , \, x_n) \,.
\end{equation}
Here $ \{y\} $ is a set of external variables and $ \xi_n $ indexes the different terms of order $ n $ which are given by the function $ D_n $. Terms corresponding to $ n = 0 $ are understood as being known functions of the external variables. In case of a discrete internal variable $ x_i $, the corresponding integral is exchanged in favor of a sum.

The method is based on the Metropolis-Hastings algorithm which samples terms of the integral series in the $ (\xi_n, \, \{y\}, \, x_1, \, \dots , \, x_n) $ parameter space. That is, a random walk is preformed between the different integrands in the integral series, as well as between the possible values of the integration variables. In this random walk it is also permissible to include one or more of the external variables. Since the terms at $ n = 0 $ are known functions it is then possible to calculate the value of $ Q $ by keeping track of the frequency by which these terms are sampled, as well as the length of the sequence of sampled terms.

To clarify any ambiguities, the DMC method will next be demonstrated by a few simple examples.

\subsection{Example 1}

In this example the task is to compute $ 1 + C $, where for convenience it is assumed that $ C > 1 $ is a constant. The integral series (\ref{eq:integralSeries}) will then consist out of two constant zeroth order terms only, making the parameter space discrete with the two possibilities $ \xi_0 = 0 $ and $ \xi_0 = 1 $ corresponding to the terms $ 1 $ and $ C $ respectively. Hence this is probably the simplest possible implementation of DMC and will make for a good first encounter.

\todo{The function $ D_n $ here play the role of $ f $ in the previous section about the MH algorithm.}

To follow the recipe of the Metropolis-Hastings algorithm, the function $ f $ is defined as being nothing but $ D_0(\xi_0) $ from (\ref{eq:integralSeries}). By this definition $ f $ becomes proportional to the probability density function 

\begin{equation}
	\rho(x) = \frac{f(x)}{\sum_y f(y)} = \frac{f(x)}{1 + C}
	\; ; \quad
	x \in \{1\,, C \} \,,
\end{equation}
from whose probability distribution function $ P $ the sequence of $ \xi_0 $'s will be drawn. Further more there can be at most four types of transitions between the two states in parameter space. By introducing the corresponding transition probabilities: $ P(1|C) $, $ P(C|1) $, $ P(1|1) $ and $ P(C|C) $, the Markov process \question{(is this the correct word?)} to be simulated may then be illustrated as in figure (\ref{fig:example1}) below.

\begin{figure}[H]
	\centering
 	\includegraphics[width=\textwidth, ]{{"Images/Examples/First example"}.pdf}
	\caption{\todo{Caption this plz!}}
	\label{fig:example1}
\end{figure}

To simplify matters, the proposal distributions $ W(1|C) $, $ W(1|1) $, $ W(C|1) $ and $ W(C|C) $ are all chosen to have the same probability of $ 1/2 $. Then, according to (\ref{eq:acceptanceRatio}), the acceptance-rejection ratios will be given by $ A(1|1) = A(1|C) = A(C|C) = 1 $ and $ A(C|1) = 1/C $. By keeping track of how many times $ \xi_0 = 0 $ appears in the generated sequence, lets say $ N_0 $ times, as well as the the total length $ N $ of the sequence, it is possible to calculate $ 1 + C $. This since
\begin{equation}
	\label{eq:example1Prop}
	N_0 \propto \rho(1) \propto 1
	\; , \quad
	N - N_0 \propto \rho(C) \propto C
	\quad \Rightarrow \quad
	\frac{N_0}{N - N_0} = \frac{1}{C}
\end{equation}
so that
\begin{equation}
	\label{eq:example1Answ}
	1 + C = 1 + \frac{N - N_0}{N_0} \,.
\end{equation}

\todo{Include an implementation written in python?}

\subsection{Example 2}

In this second example the task is to compute the sum $ 1 + \int_a^b x \diff x $.

\todo{the only unknown here is the value of the integral. The $ 1 $ is solely used for normalization purposes.}

Instead of having of having two zeroth order terms as in the first example, there is now a zeroth and first order term. This implies that the parameter space is no longer completely discrete with merely two possible states. Similarly to the first example, the zeroth order term is still represented in parameter space by the state $ \xi_0 = 0 $. On the other hand, the first order term corresponds to the infinite number of states $ (\xi_1 = 0, \, x \in [a, \, b]) $. This notation of the states in parameter space is a little cumbersome, however, by assuming $ b > a > 1 $ it is possible to create a one-to-one mapping which maps $ \xi_0 = 0 $ and $ (\xi_1 = 0, \, x \in [a, \, b]) $ onto $ x = 1 $ and $ x \in [a, \, b] $ respectively. Using this notation, a function $ f $ is defined by
\begin{equation}
	f(x) =
	\begin{dcases}
		D_0(\xi_0 = 0) = 1 \; , \quad &x = 1 \\
		D_1(\xi_1 = 0, x) = x \; , \quad &x \in [a, \, b] \,,
   	\end{dcases}
\end{equation}
and thus becomes proportional to the probability density
\begin{equation}
	\rho(x)
	= \frac{f(x)}{\sum_y \rho(y)}
	= \frac{f(x)}{1 + \int_a^b x \diff x}
	\; ; \quad
	x \in \{1\} \cup [a, \, b] \,.
\end{equation}

In order to cover the whole parameter space, it is more than sufficient to consider four types of transitions having the transition probabilities $ P(1|1) $, $ P(1|x) $, $ P(x|1) $ and $ P(x|x') $. Here it is understood that $ x, x' \in [a, \, b] $ and thus corresponds to a state of the first order term. This Markov process might be illustrated as figure \ref{fig:example2} below.

\begin{figure}[H]
	\centering
 	\includegraphics[width=\textwidth, ]{{"Images/Examples/Second example"}.pdf}
	\caption{\todo{Caption this plz!}}
	\label{fig:example2}
\end{figure}

In order to construct proposal distributions to or from the first order term, it is convenient to introduce the collection of states referred to as $ \smallint $, in which all states $ x \in [a, \, b] $. Using this notation, the proposal distributions are chosen to be
\begin{equation}
	\begin{split}
		W(1|1) &= \tfrac{1}{2} \\
		W(x|1) &= W(\smallint | 1) = \tfrac{1}{2}
	\end{split}
	\quad \quad
	\begin{split}
		W(1|x) &= W(1 | \smallint) \, U_{a,b}(x) = \tfrac{1}{2} \tfrac{1}{b-a} \\
		W(x|x') &= W(\smallint | \smallint) \,U_{a,b}(x') = \tfrac{1}{2} \tfrac{1}{b-a} \,.
	\end{split}
\end{equation}
The quantities $ W(1|1) $, $ W(1|\smallint) $, $ W(\smallint | 1) $ and $ W(\smallint | \smallint) $ are simply the probability of proposing a state corresponding to a certain term in the integral series and have been set equally probable. The quantity $ U_{a,b}(x) = [b - a]^{-1} $ is the uniform probability distribution on the interval $ [a, \, b] $ from which $ x $ is sampled. Then, from the proposal distributions follow the acceptance rations
\begin{equation}
	\begin{split}
		A(1|1) &= 1 \\
		A(x|1) &= \text{min} \Big( 1, \,  [b - a]^{-1} \, x^{-1} \Big) \\
	\end{split}
	\quad \quad
	\begin{split}
		A(1|x) &= \text{min} \Big( 1, \,  [b - a] \, x \Big) \\
		A(x|x') &= \text{min} \Big( 1, \, x^{-1} \, x' \Big) \,.
	\end{split}
\end{equation}

By keeping track of the $ N_0 $ number of times $ x = 1 $ appears in the sequence of states and also the length $ N $ of the sequence, it follows from (\ref{eq:example1Prop}) and (\ref{eq:example1Answ}) that
\begin{equation}
	1 + \int_a^b x \diff x = 1 + \frac{N - N_0}{N_0} \,.
\end{equation}

\subsection{Example 3}

In this third and final example, the task is to compute something which is more similar to the actual problem. Hence, the sum to compute is of the form,
\begin{equation}
	1 + \int_{a}^{b} \diff x \, e^{-x} + \int_{a'}^{b'} \diff y \int_{a''}^{b''} \diff z \, e^{-y -z} \,,
\end{equation}
and consists of a zeroth, first and second order term. By assuming that $ b > a > 1 $, a similar one-to-one mapping of the states in parameter space as used in the previous example may also be used here. Again the zeroth and first order terms are chosen to be represented by $ x = 1 $ and $ x \in [a, \, b] $ respectively, whilst the second order term is to be represented by $ x = (y, z) \in [a', \, b'] \times [a'', \, b''] $. In terms of this parameter $ x $, the function $ f $ is defined as
\begin{equation}
	f(x) =
	\begin{dcases}
		D_0(\xi_0 = 0) = 1 \; , \quad &x = 1 \\
		D_1(\xi_1 = 0, x) = e^{-x} \; , \quad &x \in [a, \, b] \\
		D_2(\xi_2 = 0, x) = e^{-y - z} \; , \quad &x \in [a', \, b'] \times [a'', \, b''] \,.
   	\end{dcases}
\end{equation}
By normalization a probability density function $ \rho $ is obtained whose probability distribution $ P $ and seven types of transitions form a Markov process illustrated in figure \ref{fig:example3}.

\begin{figure}[H]
	\centering
 	\includegraphics[width=\textwidth, ]{{"Images/Examples/Third example"}.pdf}
	\caption{\todo{Caption this plz!}}
	\label{fig:example3}
\end{figure}

In order to construct transition probabilities it is convenient to introduce the collection of states $ \smallint $ and $ \smallint \!\! \smallint $. These contain all states in parameter space corresponding the first and second order term respectively. The transition probabilities are then chosen as
\begin{equation}
	\begin{split}
		W(1|x) &= W(1|\smallint) \, U_{a,b}(x) \\
		W(x|1) &= W(\smallint|1) \\
		W(y,z|x) &= W(\smallint \!\! \smallint | \smallint) \, U_{a,b}(x) \\
		W(x|x') &= W(\smallint | \smallint) \,U_{a,b}(x') \,,
	\end{split}
	\quad \quad
	\begin{split}
		W(x|y,z) &= W(\smallint | \smallint \!\! \smallint) \, U_{a',b'}(y) \, U_{a'',b''}(z) \\
		W(y,z|y',z) &= W(\smallint \!\! \smallint | \smallint \!\! \smallint) \, W(\smallint \!\! \smallint | y') \, U_{a',b'}(y') \\
		W(y,z|y,z') &= W(\smallint \!\! \smallint | \smallint \!\! \smallint) \, \, W(\smallint \!\! \smallint | z') \, U_{a'',b''}(z') \\
		\;
	\end{split}
\end{equation}
where
\begin{equation}
	\begin{split}
		W(1|\smallint) &= 1 \\
		W(\smallint | 1) &= W(\smallint | \smallint) = W(\smallint | \smallint \!\! \smallint) = \tfrac{1}{3} \\
		W(\smallint \!\! \smallint | \smallint) &= W(\smallint \!\! \smallint | \smallint \!\! \smallint) = W(\smallint \!\! \smallint | y') = W(\smallint \!\! \smallint | z') = \tfrac{1}{2} \,.
	\end{split}
\end{equation}
The discrete proposal distributions $ W(\smallint \!\! \smallint | y') $ and $ W(\smallint \!\! \smallint | z') $ correspond to choosing to update either the $ y $ or the $ z $ part of the state $ x $. Having all of this information it is then trivial to calculate the acceptance ratios, which become
\begin{equation}
	\begin{split}
		W(1|x) &= \text{min} \Big(1, \, \tfrac{1}{3} [b - a] \, e^{-x} \Big) \\
		W(x|1) &= \text{min} \Big(1, \, 3 \, [b - a]^{-1} \, e^{x} \Big) \\
		W(x|x') &= \text{min} \Big(1, \, e^{x - x'} \Big) \\
		W(x|y,z) &=\text{min} \Big(1, \, \tfrac{2}{3} [b' - a'][b'' - a''][b - a]^{-1} \, e^{x - y - z} \Big) \\
		W(y,z|x) &= \text{min} \Big(1, \, \tfrac{3}{2} [b' - a']^{-1}[b'' - a'']^{-1}[b - a] \, e^{y + z - x} \Big) \\
		W(y,z|y',z) &= \text{min} \Big(1, \, e^{y - y'} \Big) \\
		W(y,z|y,z') &= \text{min} \Big(1, \, e^{z - z'} \Big) \,.
	\end{split}
\end{equation}

By defining $ N_0 $ and $ N $ in accordance to what was done in the previous example, the value of the sum is obtained by
\begin{equation}
	1 + \int_{a}^{b} \diff x \, e^{-x} + \int_{a'}^{b'} \diff y \int_{a''}^{b''} \diff z \, e^{-y -z}
	= 1 + \frac{N - N_0}{N_0} \,.
\end{equation}

\section{Implementation}

The task at hand is now to implement the DMC method in order to calculate the electronic single-particle Green's function $ \Gt(\alpha, \mu, \vec p, \tau) $. The integral series (\ref{eq:integralSeries}) will then be nothing but the diagrammatic series (\ref{eq:GinTermsOfDiagrams}), with the external parameters $ \{ y \} = \{ \alpha, \mu, \vec p, \tau \} $. The integration variables $ x_i $'s must therefore correspond to the internal imaginary-times and momenta, where the internal momenta are chosen to be those of the phonon propagators. By then representing the internal momenta in spherical coordinates $ \vec q = (q \sin \theta \cos \varphi, q \sin \theta \sin \varphi, q \cos \theta) $, the momentum integrals should be replaced according to
\begin{equation}
	\int \frac{\diff^3 q}{(2 \pi)^3}
	\rightarrow
	\int \limits_{q=0}^\infty \int \limits_{\theta=0}^{\pi} \int \limits_{\varphi=0}^{2\pi} \frac{q^2 \sin \theta \diff q \diff \theta \diff \varphi}{(2 \pi)^3} \,.
\end{equation}
The beauty of this is realized when recalling that each phonon brings with it a factor $ V(q)^2 \propto q^{-2} $, whose momentum dependence exactly cancel with that of the integral. For example, the expression corresponding the first order diagram then becomes
\begin{equation}
	-
	\int \limits_{0}^{\tau} \diff \tau_2
	\int \limits_{0}^{\tau_2} \diff \tau_1
	\int \limits_0^\infty \diff q
	\int \limits_0^\pi \diff \theta
	\int \limits_0^{2 \pi} \diff \varphi
	\, \Gt_0(\vec p, \tau_1)
	\Gt_0(\vec p - \vec q, \tau_2 - \tau_1)
	\tilde \Dt_0(\vec q, \tau_2 - \tau_1)
	\Gt_0(\vec p, \tau - \tau_2) \,,
\end{equation}
where $ \tilde \Dt_0(\vec q, \tau) $ is a phonon propagator which has absorbed the factor $ q^2 \sin \theta  \, (2\pi)^{-3} $ originating from the integral, the interaction potential $ V(q)^2 $ along with the factor $ -1 $ from the Feynman rules. Thus
\begin{equation}
	\tilde \Dt_0(\vec q, \tau)
	=
	\frac{2\sqrt 2 \pi \alpha}{(2\pi)^3} \sin \theta \, \exp \{ - \tau\}
\end{equation}
which is a quantity always larger than or equal to zero. The integrand of each and every integral in the integral series will be entirely made up out of $ \Gt_0 $'s and $ \tilde \Dt_0 $'s which implies that every contribution to $ \Gt $ is a positive contribution. This will simplify the DMC implementation since it wont be necessary to calculate what sign each sampled parameter space state comes with.

The external parameters $ \vec p $ and $ \tau $ will be the only ones allowed to change during the Markov process. Including $ \alpha $ and/or $ \mu $ would cause the parameter space to increase and the statistics to be spread out. Thus more computation time would be needed to calculate quantities to the same level of certainty as having $ \alpha $ and $ \mu $ fixed.

The value of the propagator $ \Gt $ will be computed at the discrete set of points $ \vec p_i = \Delta p(0.5 + i) \, \hat{ \vec e}_z $ and $ \tau_j = \Delta \tau (0.5 + j) $ where $ i = 0, \, 1, \, 2, \, \dots, \, N - 1  $, $ j = 0, \, 1, \, 2, \, \dots, \, M - 1 $ and the resolution is chosen in terms of $ \Delta p $ and $ \Delta \tau $. To calculate $ \Gt(\vec p_i, \tau_j) = \Gt_{i, j} $, both a bin $ N_0 $ and a two dimensional histogram $ N $ are used, even though $ \vec p $ and $ \tau $ will be continuous variables. Thus the bin $ N_{i,j} $ of the histogram will be covering the range $ p \in [p_i - \Delta p/2, \, p_i + \Delta p/2] $ and $ \tau \in [\tau_j - \Delta \tau/2, \, \tau_j + \Delta \tau/2] $ of the external parameter values. The value of every bin in the histogram along with $ N_0 $ are initially put to zero. Then, each time a parameter space state is sampled, it will be checked wether or not this state belongs to the zeroth order term $ \Gt_0(\vec p, \tau) $. If this is the case, the value of $ N_0 $ is increased by 1, if not, the bin in the histogram according to the external parameters is increased by 1. By doing this, the quantities $ N_0 $ and $ N_{i,j} $ can be shown to be proportional to
\begin{equation}
	\begin{split}
		N_0
		&\propto
		\int \limits_{0}^{N\Delta p} \! \! \diff p \int \limits_{0}^{M\Delta p} \! \! \diff \tau \, \Gt_0(\vec p, \tau) \\
		&=
		\Delta p \, \Delta \tau \sum_{k,l} \Gt_0(\vec p_k, \tau_l) + \mathcal{O} \left( [\Delta p]^3 + [\Delta \tau]^3 \right)
	\end{split}
\end{equation}
and
\begin{equation}
	\begin{split}
		N_{i,j}
		&\propto
		\int \limits_{p_{i - 0.5}}^{p_{i + 0.5}} \! \! \! \diff p \int \limits_{\tau_{j - 0.5}}^{\tau_{j + 0.5}} \! \! \! \diff \tau \left[ \Gt(\vec p, \tau) - \Gt_0(\vec p, \tau) \right] \\
		&=
		\Delta p \, \Delta \tau \left[ \Gt(\vec p_i, \tau_j) - \Gt_0(\vec p_i, \tau_j) \right] + \mathcal{O} \left( [\Delta p]^3 + [\Delta \tau]^3 \right)
	\end{split}
\end{equation}
respectively. Omitting the errors due to discretization, the interacting electronic propagator is then found to be
\begin{equation}
	\Gt(\vec p_i, \tau_j)
	=
	\Gt_0(\vec p_i, \tau_j) + N_{i, j} \frac{\sum_{k, l} \Gt_0(\vec p_k, \tau_l)}{N_0} \,.
\end{equation}

\todo{On the other hand, if the external momentum is held fixed at a value $ \vec p_0 $, the propagator would only be a discrete function of the imaginary-time...}
\begin{equation}
	\Gt(\vec p_0, \tau_j) = \Gt_0(\vec p_0, \tau_j) + N_j \frac{\sum_l \Gt_0(\vec p_0, \tau_l)}{N_0} \,.
\end{equation}


\begin{itemize}
	\item \todo{introduce $ \tau_\text{max} $ and $ p_\text{max} $.}

	\item \todo{Quickly mention the code implementation. momenta belongs to lines, time to nodes. Nodes instead of vertices in order to keep things general (when sampling $ \Sigma* $)}
\end{itemize}

\section{Bare scheme update procedures for $ \Gt$}

What remains to be discussed is how the sampling of states in parameter space occurs. As the name Diagrammatic Monte Carlo suggest, the diagrammatic representation of the integral series will be used. That is, the functions $ D_n $ in the integral series (\ref{eq:integralSeries}) is to be though of as a Feynman diagram (without the integrals). The random walk, which is used to simulate the Markov process, will thus be in terms of such diagrams. It is then important that each and every such diagram must be possible to reach in order to cover all of parameter space and thus maintaining ergodicity. To make sure that this actually is the case, a set of update procedures \cite{MishchenkoA.2000DqMC} have been constructed.


\subsection*{Change of diagram length in time, type 1}

\begin{figure}[H]
	\begin{fmffile}{NORMALchangeOfDiagramLengthType1}
		\begin{equation*}
		        	\begin{gathered}
				\begin{fmfgraph*}(40, 7)
					\fmfstraight
					\fmftop{t1,t2,t3,t4,t5,t6}
					\fmfbottom{b1,b2,b3,b4,b5,b6}
					\fmf{dots}{b1,b2}
					\fmf{fermion}{b2,b4}
					\fmf{fermion}{b4,b6}
					\fmf{dashes}{b2,t2}
					\fmf{dashes}{b4,t4}
					\fmfdot{b2,b4}
					\fmfv{label=$ \tau_{2n - 2} $, label.angle=-90}{b2}
					\fmfv{label=$ \tau_{2n - 1} $, label.angle=-90}{b4}
        					\fmfv{label=$ \textcolor{highlight}{\tau} $, label.angle=0}{b6}
				\end{fmfgraph*}
        			\end{gathered}
			\quad \quad \rightarrow \quad
		        	\begin{gathered}
				\begin{fmfgraph*}(40, 7)
					\fmfstraight
					\fmftop{t1,t2,t3,t4,t5,t6}
					\fmfbottom{b1,b2,b3,b4,b5,b6}
					\fmf{dots}{b1,b2}
					\fmf{fermion}{b2,b4}
					\fmf{fermion}{b4,b6}
					\fmf{dashes}{b2,t2}
					\fmf{dashes}{b4,t4}
					\fmfdot{b2,b4}
					\fmfv{label=$ \tau_{2n - 2} $, label.angle=-90}{b2}
					\fmfv{label=$ \tau_{2n - 1} $, label.angle=-90}{b4}
        					\fmfv{label=$ \textcolor{highlight}{\tau'} $, label.angle=0}{b6}
				\end{fmfgraph*}
        			\end{gathered}
		\end{equation*}
	\end{fmffile}
	\caption{The only affected parameter is the highlighted imaginary-time of the end point node.}
	\label{fig:NORMALcodl1}
\end{figure}
This update procedure merely changes the external imaginary-time parameter $ \tau $, which is nothing but the diagram length in time. In the first update type this is achieved by altering the time of the end point node in the diagram, i.e. $ \tau \rightarrow \tau' $, as illustrated in figure \ref{fig:NORMALcodl1}. The only affected quantity of such an update will be the value of the very last $ \Gt_0 $ in the diagram so that
\begin{equation}
	\frac{D_n(\tau')}{D_n(\tau)}
	= \frac{\Gt_0(\vec p, \tau' - \tau_{2n - 1})}{\Gt_0(\vec p, \tau - \tau_{2n - 1})} 
	= \frac{\exp \left\{ -\left(\frac{p^2}{2} - \mu \right) \tau' \right\}}{\exp \left\{ -\left(\frac{p^2}{2} - \mu \right) \tau \right\}}
\end{equation}

Now consider an exponential distribution on the interval $ [\tau_{2n - 1}, \, \tau_\text{max}] $ with rate parameter $ \lambda = p^2/2 - \mu $ of which the density is
\begin{equation}
	\rho(\tau) = \frac{\lambda \, e^{-\lambda (\tau - \tau_{2n - 1})}}{1 - e^{- \lambda (\tau_\text{max} - \tau_{2n - 1})}} \,.
\end{equation}
By sampling $ \tau' $ from such a distribution, the ratio $ W(\tau' | \tau)/W(\tau | \tau') $ will be the inverse of $ D_n'/D_n $. Hence the acceptance ratio $ A(\tau | \tau') $ of this update procedure becomes 1, and any proposed $ \tau' $ is always be accepted.

\subsection*{Change of diagram length in time, type 2}

\begin{itemize}
	\item \todo{Mention something about the probability of choosing a node on random will cancel is chosen uniformly. Tell the reader that this is also the case for all other updates procedures as long as nothing else is said.}
\end{itemize}

\begin{figure}[H]
	\begin{fmffile}{NORMALchangeOfDiagramLengthType2}
		\begin{equation*}
		        	\begin{gathered}
				\begin{fmfgraph*}(50, 7)
					\fmfstraight
					\fmftop{t1,t2,t3,t4,t5,t6,t7,t8,t9}
					\fmfbottom{b1,b2,b3,b4,b5,b6,b7,b8,b9}
					\fmf{dots}{b1,b2}
					\fmf{fermion}{b2,b4}
					\fmf{fermion}{b4,b6}
					\fmf{dots}{b6,b7}
					\fmf{fermion}{b7,b9}
					\fmf{dashes}{b2,t2}
					\fmf{dashes}{b4,t4}
					\fmf{dashes}{b6,t6}
					\fmf{dashes}{b7,t7}
					\fmfdot{b2,b4,b6,b7}
					\fmfv{label=$ \tau_{k -1} $, label.angle=-90}{b2}
					\fmfv{label=$ \textcolor{highlight}{ \tau_{k} } $, label.angle=-90}{b4}
					\fmfv{label=$ \textcolor{highlight}{ \tau_{k + 1} \;\;\; } $, label.angle=-90}{b6}
					\fmfv{label=$ \;\;\;\;\; \textcolor{highlight}{ \tau_{2n - 1} } $, label.angle=-90}{b7}
        					\fmfv{label=$ \textcolor{highlight}{\tau} $, label.angle=0}{b9}
				\end{fmfgraph*}
        			\end{gathered}
			\quad \quad \rightarrow \quad
		        	\begin{gathered}
				\begin{fmfgraph*}(50, 7)
					\fmfstraight
					\fmftop{t1,t2,t3,t4,t5,t6,t7,t8,t9}
					\fmfbottom{b1,b2,b3,b4,b5,b6,b7,b8,b9}
					\fmf{dots}{b1,b2}
					\fmf{fermion}{b2,b4}
					\fmf{fermion}{b4,b6}
					\fmf{dots}{b6,b7}
					\fmf{fermion}{b7,b9}
					\fmf{dashes}{b2,t2}
					\fmf{dashes}{b4,t4}
					\fmf{dashes}{b6,t6}
					\fmf{dashes}{b7,t7}
					\fmfdot{b2,b4,b6,b7}
					\fmfv{label=$ \tau_{k -1} $, label.angle=-90}{b2}
					\fmfv{label=$ \textcolor{highlight}{ \tau_{k}' } $, label.angle=-90}{b4}
					\fmfv{label=$ \textcolor{highlight}{ \tau_{k + 1}' \;\;\; } $, label.angle=-90}{b6}
					\fmfv{label=$ \;\;\;\;\; \textcolor{highlight}{ \tau_{2n - 1}' } $, label.angle=-90}{b7}
        					\fmfv{label=$ \textcolor{highlight}{\tau'} $, label.angle=0}{b9}
				\end{fmfgraph*}
        			\end{gathered}
		\end{equation*}
	\end{fmffile}
	\caption{The highlighted $ \tau $'s are the parameters affected by this update.}
	\label{fig:NORMALcodl2}
\end{figure}

This update procedure also changes the external imaginary-time parameter, although it does so in a slightly different by letting any $ \Gt_0 $ in the diagram be lengthen or shortened in time, not just the last one. This is achieved by randomly picking any but the leading node in the diagram to assign a new imaginary-time $ \tau_k' $ from the interval $ [\tau_{k-1}, \, \tau_\text{max} - (\tau - \tau_k)] $. In order to only modify the length of the electronic propagator just in front of the chosen node, every node proceeding this node must clearly have the difference $ \tau_k' - \tau_k $  added to its time. This is illustrated in figure \ref{fig:NORMALcodl2}.

This update does not merely affect the one $ \Gt_0 $, but phonon propagators with start and end points on different sides of the chosen node would also have their length modified by the difference $ \tau_k' - \tau_k $. If there are $ m $ such phonons, the quota of the diagram values become
\begin{equation}
	\begin{split}
		\frac{D_n(\tau')}{D_n(\tau)}
		&= \frac{
			\Gt_0(\vec p, \tau_k - \tau_{k-1}) \prod \limits_{i=0}^{m-1} \tilde \Dt_0(\vec q_i, \Delta \tau_i)
		}{
			\Gt_0(\vec p, \tau_k' - \tau_{k-1}) \prod \limits_{j=0}^{m-1} \tilde \Dt_0(\vec q_j, \Delta \tau_j + [\tau_k' - \tau_k])
		} \\[6pt]
		&= \frac{\exp \left\{ -\left(\frac{p^2}{2} - \mu + m \right) \tau_k' \right\}}{\exp \left\{ -\left(\frac{p^2}{2} - \mu + m \right) \tau_k \right\}} \,,
	\end{split}
\end{equation}
where $ \Delta \tau_i $ is the length in time of the $ i $th phonon propagator. By sampling the $ \tau_k' $ from an exponential distribution with rate parameter $ \lambda = p^2/2 - \mu + m $, the acceptance ration for this update procedure also becomes unity.

This second version of the change of diagram length update procedure is more complex than the first one, and may therefore be chosen less often. In a worst case scenario the complexity scales as $ \mathcal{O} (2n) $, due to figuring out the number of phonons $ m $ just discussed. Only one of the procedures changing the length of the diagram would be sufficient, but having an over complete set of update procedures is necessarily not something negative and could potentially enhance the statistics.

\subsection*{Change of external momentum}

\begin{figure}[H]
	\begin{fmffile}{NORMALchangeOfExternalMomentum}
		\begin{equation*}
		        	\begin{gathered}
				\begin{fmfgraph*}(50, 7)
					\fmfstraight
					\fmftop{t1,t2,t3,t4,t5,t6,t7,t8,t9,t10}
					\fmfbottom{b1,b2,b3,b4,b5,b6,b7,b8,b9,b10}
					\fmf{fermion, label=$ \textcolor{highlight}{\vec p_0} $, label.side=left}{b1,b3}
					\fmf{fermion, label=$ \textcolor{highlight}{\vec p_1} $, label.side=left}{b3,b5}
					\fmf{dots}{b5,b6}
					\fmf{fermion, label=$ \textcolor{highlight}{\vec p_{2n - 1}} $, label.side=left}{b6,b8}
					\fmf{fermion, label=$ \textcolor{highlight}{\vec p_{2n}} $, label.side=left}{b8,b10}
					\fmf{dashes}{b3,t3}
					\fmf{dashes}{b5,t5}
					\fmf{dashes}{b6,t6}
					\fmf{dashes}{b8,t8}
					\fmfdot{b3,b5,b6,b8}
				\end{fmfgraph*}
        			\end{gathered}
			\quad \quad \rightarrow \quad \quad
		        	\begin{gathered}
				\begin{fmfgraph*}(50, 7)
					\fmfstraight
					\fmftop{t1,t2,t3,t4,t5,t6,t7,t8,t9,t10}
					\fmfbottom{b1,b2,b3,b4,b5,b6,b7,b8,b9,b10}
					\fmf{fermion, label=$ \textcolor{highlight}{\vec p'_0} $, label.side=left}{b1,b3}
					\fmf{fermion, label=$ \textcolor{highlight}{\vec p'_1} $, label.side=left}{b3,b5}
					\fmf{dots}{b5,b6}
					\fmf{fermion, label=$ \textcolor{highlight}{\vec p'_{2n - 1}} $, label.side=left}{b6,b8}
					\fmf{fermion, label=$ \textcolor{highlight}{\vec p'_{2n}} $, label.side=left}{b8,b10}
					\fmf{dashes}{b3,t3}
					\fmf{dashes}{b5,t5}
					\fmf{dashes}{b6,t6}
					\fmf{dashes}{b8,t8}
					\fmfdot{b3,b5,b6,b8}
				\end{fmfgraph*}
        			\end{gathered}
		\end{equation*}
	\end{fmffile}
	\caption{This update procedure changes the momentum of every $ \Gt_0 $ in the diagram by the external momentum difference $ \vec p' - \vec p $. Surely it must be the case that $ \vec p_0  = \vec p_{2n} = \vec p $ and the same is of course true in primed case as well.}
	\label{fig:NORMALcoem}
\end{figure}

Since there is no preferred direction of the Hamiltonian (\ref{eq:finalHamiltonian}), the Green's function $ \Gt $ becomes dependent merely upon the magnitude of the external momentum $ \vec p $. \todo{(this is supposed to have been discussed at an earlier point!)} This update procedure is thus constructed to keep the direction constant while changing only the magnitude $ p \rightarrow p' $. In order to satisfy momentum conservation at each vertex, the $ \Gt_0 $'s are chosen to absorbs the external momentum difference $ \vec p' - \vec p $ leaving the value of the $ \tilde \Dt_0 $'s the same. This is illustrated in figure \ref{fig:NORMALcoem}. The ratio of the diagram value after to before such an update then becomes
\begin{equation}
	\label{eq:externalMomentumUpdateRatio}
	\begin{split}
		\frac{D_n(\vec p')}{D_n'(\vec p)}
		&= \frac{
			\prod \limits_{i=0}^{2n} \Gt_0(\vec p'_i, \tau_{i + 1} - \tau_i)
		}{
			\prod \limits_{j=0}^{2n} \Gt_0(\vec p_j, \tau_{j + 1} - \tau_j)
		} \\
		&= \exp \left\{ - \frac{1}{2} \sum \limits_{i=0}^{2n} \left( \left[ \vec p_i + (\vec p' - \vec p) \right]^2  - p_i^2 \right) (\tau_{i + 1} - \tau_i) \right\} \\
		&= \exp \left\{ - \frac{\tau}{2} \left( [p' - p]^2 + 2 \langle \vec p \rangle_{0, 2n} \cdot [\vec p' - \vec p] \right) \right\}
	\end{split}
\end{equation}
where the mean electronic momentum is defined as
\begin{equation}
	\langle \vec p \rangle_{k,l} \equiv \sum \limits_{i = k}^{l} \frac{\tau_{i + 1} - \tau_i}{\tau} \, \vec p_i \,.
\end{equation}

By sampling $ p' \in [0, \, p_\text{max}] $ using a truncated half-normal distribution whose corresponding normal distribution would have the standard deviation $ \sigma = 1/\sqrt \tau $, the fraction of the proposal distributions take the value
\begin{equation}
	\frac{W(\vec p' | \vec p)}{W(\vec p | \vec p')} = \exp \left\{ - \frac{\tau}{2} (p^2 - p'^2) \right\}
\end{equation}
so that the acceptance ratio is found to be
\begin{equation}
	\begin{split}
		A(p|p')
		&= \text{min} \Big( 1, \, \exp \big\{ - (\vec p' - \vec p) \cdot (\langle \vec p \rangle_{0,2n} - \vec p) \, \tau \big\} \Big) \\
		&= \text{min} \Big( 1, \, \exp \big\{ - (p' - p) \, (\langle p_z \rangle_{0,2n} - p) \, \tau \big\} \Big) \,.
	\end{split}
\end{equation}
In the final equality the vectors has ben represented in a Cartesian coordinate system with the $ z $-axis parallel to the external momentum. On average $ \langle p_z \rangle_{0,2n} $ should not differ to much from $ p $, implying that both the exponential and the acceptance ration should be close to unity most of the time. This of course being the reason why the update procedure is constructed the way it is.

\question{Perhaps $ \langle p_z \rangle_{0,2n} = p $ on average?}

\subsection*{Change of transferred momentum magnitude}

\begin{figure}[H]
	\begin{fmffile}{NORMALchangeOfTransferredMomentum}
		\begin{equation*}
		        	\begin{gathered}
				\begin{fmfgraph*}(40, 20)
					\fmfstraight
					\fmftop{t1,t2,t3,t4,t5,t6,t7,t8}
					\fmfbottom{b1,b2,b3,b4,b5,b6,b7,b8}
					\fmf{dots}{b1,b2}
					\fmf{fermion, label=$ \textcolor{highlight}{\vec p_a} $, label.side=left}{b2,b4}
					\fmf{dots}{b4,b5}
					\fmf{fermion, label=$ \textcolor{highlight}{\vec p_b} $, label.side=left}{b5,b7}
					\fmf{dots}{b7,b8}
					\fmf{dashes, tension=1.5}{b4,v1}
					\fmf{phantom}{v1,t4}
					\fmf{dashes, tension=1.5}{b5,v2}
					\fmf{phantom}{v2,t5}
					\fmf{dashes, left, tension=0, label=$ \textcolor{highlight}{\vec q_k} $, label.side=left}{b2,b7}
					\fmfdot{b2,b4,b5,b7}
					\fmfv{label=$ \tau_a $, label.angle=-90}{b2}
					\fmfv{label=$ \tau_{b+1} $, label.angle=-90}{b7}
				\end{fmfgraph*}
        			\end{gathered}
			\quad \quad \rightarrow \quad \quad
		        	\begin{gathered}
				\begin{fmfgraph*}(40, 20)
					\fmfstraight
					\fmftop{t1,t2,t3,t4,t5,t6,t7,t8}
					\fmfbottom{b1,b2,b3,b4,b5,b6,b7,b8}
					\fmf{dots}{b1,b2}
					\fmf{fermion, label=$ \textcolor{highlight}{\vec p'_a} $, label.side=left}{b2,b4}
					\fmf{dots}{b4,b5}
					\fmf{fermion, label=$ \textcolor{highlight}{\vec p'_b} $, label.side=left}{b5,b7}
					\fmf{dots}{b7,b8}
					\fmf{dashes, tension=1.5}{b4,v1}
					\fmf{phantom}{v1,t4}
					\fmf{dashes, tension=1.5}{b5,v2}
					\fmf{phantom}{v2,t5}
					\fmf{dashes, left, tension=0, label=$ \textcolor{highlight}{\vec q_k'} $, label.side=left}{b2,b7}
					\fmfdot{b2,b4,b5,b7}
					\fmfv{label=$ \tau_a $, label.angle=-90}{b2}
					\fmfv{label=$ \tau_{b+1} $, label.angle=-90}{b7}
				\end{fmfgraph*}
        			\end{gathered}
		\end{equation*}
	\end{fmffile}
	\caption{The momentum transferred via an internal phonon propagator is updated. In order obey momentum conservation at every vertex, electronic propagators beneath the phonon arc absorb the momentum difference.}
	\label{fig:NORMALcotm}
\end{figure}

This update procedure is designed to be very similar to that of the external momentum. However, the main difference of course being that the magnitude of momentum transferred via a phonon propagator is updated rather than the external momentum. In order to achieve this, a $ \tilde \Dt_0 $ is randomly picked and has a new momentum magnitude assigned to it $ q_k \rightarrow q'_k $ while keeping the direction fixed. In order to conserve momentum at the two vertices connected to the phonon propagator, the $ \Gt_0 $'s located beneath the phonon arc should absorb the momentum difference $ \vec q_k - \vec q'_k $. This is illustrated in figure \ref{fig:NORMALcotm}. Since the $ \tilde \Dt(\vec q, \tau) $'s does not depend on the magnitude $ q = | \vec q | $, the ratio of diagram values become
\begin{equation}
	\begin{split}
		\frac{D_n(\vec q'_k)}{D_n(\vec q_k)}
		&= \frac{
			\prod \limits_{i=a}^{b} \Gt_0(\vec p'_i, \tau_{i + 1} - \tau_i)
		}{
			\prod \limits_{j=a}^{b} \Gt_0(\vec p_j, \tau_{j + 1} - \tau_j)
		} \\
		&= \exp \left\{ - \frac{1}{2} \sum \limits_{i=a}^b \left( \left[ \vec p_i + (\vec q_k - \vec q'_k) \right]^2  - p_i^2 \right) (\tau_{i + 1} - \tau_i) \right\} \\
		&= \exp \left\{ - \frac{\tau_{b + 1} - \tau_a}{2} \left( [q_k - q'_k]^2 + 2 \langle \vec p \rangle_{a,b} \cdot [\vec q_k - \vec q'_k] \right) \right\} \,,
	\end{split}
\end{equation}
which indeed is similar to (\ref{eq:externalMomentumUpdateRatio}). Following in the footsteps of the previous update procedure, $ q'_k \in [0, \infty[ $ is sampled from a half-normal distribution whose corresponding normal distribution would have the standard deviation $ \sigma = 1/\sqrt{\tau_{b+1} - \tau_a} $. The acceptance ration is then found to be,
\begin{equation}
	A(\vec q_k | \vec q'_k)
	=
	\text{min} \Big( 1, \, \exp \big\{ - (\vec q_k - \vec q'_k) \cdot (\langle \vec p \rangle_{a,b} + \vec q_k) \, [\tau_{b+1} - \tau_a] \big\} \Big) \,.
\end{equation}
It is reasonable to assume that on average, $ \langle \vec p \rangle_{a,b} + \vec q_k $ does not differ too much from the external momentum $ \vec p $. Hence this update procedure should have an acceptance ration close to unity at low external momenta whilst performing worse at higher external momenta.

\subsection*{Change of transferred momentum direction}

This update procedure changes the direction $ (\theta_k, \, \varphi_k) \rightarrow (\theta'_k, \, \varphi'_k) $ of the momentum transferred via a phonon propagator. As in the previous update procedure, the electronic propagators below the phonon arc absorb the momentum difference $ \vec q_k - \vec q'_k $ which is illustrated in figure \ref{fig:NORMALcotm}. This time, since $ \tilde \Dt \propto \sin \theta $ the ratio of the diagram values becomes slightly different
\begin{equation}
	\begin{split}
		\frac{D_n(\vec q'_k)}{D_n(\vec q_k)}
		&= \frac{\sin \theta'_k}{\sin \theta_k}
		\frac{
			\prod \limits_{i=a}^{b} \Gt_0(\vec p'_i, \tau_{i + 1} - \tau_i)
		}{
			\prod \limits_{j=a}^{b} \Gt_0(\vec p_j, \tau_{j + 1} - \tau_j)
		} \\
		&= \frac{\sin \theta'_k}{\sin \theta_k}
		\exp \left\{ - \frac{\tau_{b + 1} - \tau_a}{2} \left( [\vec q_k - \vec q'_k]^2 + 2 \langle \vec p \rangle_{a,b} \cdot [\vec q_k - \vec q'_k] \right) \right\} \,.
	\end{split}
\end{equation}
By sampling the azimuthal angle uniformly on the interval $ \varphi'_k \in [0, \, 2\pi ] $, and the polar angle $ \theta'_k \in [0, \, \pi] $ from a probability distribution whose density $ \rho(\theta'_k) = \tfrac{1}{2} \sin \theta'_k $, one obtains the acceptance ratio
\begin{equation}
	A(\vec q_k | \vec q'_k)
	= \min{1, \, \exp \left\{ - \frac{\tau_{b + 1} - \tau_a}{2} \left( [\vec q_k - \vec q'_k]^2 + 2 \langle \vec p \rangle_{a,b} \cdot [\vec q_k - \vec q'_k] \right) \right\} } \,.
\end{equation}


\subsection*{Vertex shift in time}

\begin{figure}[H]
	\begin{fmffile}{NORMALvertexShiftInTime}
		\begin{equation*}
		        	\begin{gathered}
				\begin{fmfgraph*}(40, 7)
					\fmfstraight
					\fmftop{t1,t2,t3,t4,t5,t6,t7}
					\fmfbottom{b1,b2,b3,b4,b5,b6,b7}
					\fmf{dots}{b1,b2}
					\fmf{fermion}{b2,b4}
					\fmf{fermion}{b4,b6}
					\fmf{dots}{b6,b7}
					\fmf{dashes}{b2,t2}
					\fmf{dashes}{b4,t4}
					\fmf{dashes}{b6,t6}
					\fmfdot{b2,b4,b6}
					\fmfv{label=$ \tau_{k -1} $, label.angle=-90}{b2}
					\fmfv{label=$ \textcolor{highlight}{ \tau_{k} } $, label.angle=-90}{b4}
					\fmfv{label=$ \tau_{k + 1} $, label.angle=-90}{b6}
				\end{fmfgraph*}
        			\end{gathered}
			\quad \quad \rightarrow \quad \quad
		        	\begin{gathered}
				\begin{fmfgraph*}(40, 7)
					\fmfstraight
					\fmftop{t1,t2,t3,t4,t5,t6,t7}
					\fmfbottom{b1,b2,b3,b4,b5,b6,b7}
					\fmf{dots}{b1,b2}
					\fmf{fermion}{b2,b4}
					\fmf{fermion}{b4,b6}
					\fmf{dots}{b6,b7}
					\fmf{dashes}{b2,t2}
					\fmf{dashes}{b4,t4}
					\fmf{dashes}{b6,t6}
					\fmfdot{b2,b4,b6}
					\fmfv{label=$ \tau_{k -1} $, label.angle=-90}{b2}
					\fmfv{label=$ \textcolor{highlight}{ \tau_{k}' } $, label.angle=-90}{b4}
					\fmfv{label=$ \tau_{k + 1} $, label.angle=-90}{b6}
				\end{fmfgraph*}
        			\end{gathered}
		\end{equation*}
	\end{fmffile}
	\caption{The imaginary-time of internal node $ k $ is updated.}
	\label{fig:NORMALvsit}
\end{figure}

This update procedure changes the imaginary-time $ \tau_k \rightarrow \tau'_k $ of a randomly chosen internal node whilst keeping the chronological ordering, i.e $ \tau_{k-1} < \tau'_k < \tau_{k+1} $. The procedure is illustrated in figure \ref{fig:NORMALvsit}, and as can be seen, it does only affect the three propagators connected to the node so that
\begin{equation}
	\begin{split}
		\frac{D_n(\tau'_k)}{D_n(\tau_k)}
		&= \frac{
			\Gt_0(\vec p_{k-1}, \tau'_k - \tau_{k_1}) \, \Gt_0(\vec p_k, \tau_{k+1} - \tau'_k) \, \tilde \Dt_0(\vec q_k, \pm (\tau_l - \tau'_k))
		}{
			\Gt_0(\vec p_{k-1}, \tau'_k - \tau_{k_1}) \, \Gt_0(\vec p_k, \tau_{k+1} - \tau_k) \, \tilde \Dt_0(\vec q_k, \pm (\tau_l - \tau_k))
		} \\
		&= \exp \left\{  - \left[ \frac{p_{k-1}^2}{2} - \frac{p_k^2}{2}  \mp 1 \right] (\tau' - \tau) \right\} \,.
	\end{split}
\end{equation}
Here the upper sign is used if $ \tau_l > \tau_k $, meaning that the phonon propagator is leaving to node $ l $ from node $ k $. If instead $ \tau_l < \tau_k $, the lower sign should be used and the situation becomes the opposite. By sampling $ \tau'_k $ from the interval $ [\tau_{k-1}, \, \tau_{k+1}] $ using an exponential distribution with rate parameter $ \lambda = p_{k-1}^2/2 - p_k^2/2  \mp 1 $, the acceptance ration becomes unity.

\subsection*{Change of diagram structure}

\begin{figure}[H]
	\begin{fmffile}{NORMALchangeOfDiagramStructure}
		\begin{equation*}
		        	\begin{gathered}
				\begin{fmfgraph*}(40, 15)
					\fmfstraight
					\fmftop{t1,t2,t3,t4,t5}
					\fmfbottom{b1,b2,b3,b4,b5}
					\fmf{dots}{b1,b2}
					\fmf{fermion, label=$ \textcolor{highlight}{\vec p_k} $, label.side=left}{b2,b4}
					\fmf{dots}{b4,b5}
					\fmf{dashes, foreground=(0,,0,,1)}{b2,t2}
					\fmf{dashes, foreground=(1,,0,,0)}{b4,t4}
					\fmfdot{b2,b4}
        					\marrow{a}{left}{lft}{$ c_1 q_1 $}{b2,t2}
        					\marrow{b}{right}{rt}{$ c_2 q_2 $}{b4,t4}
					\fmfv{label=$ \tau_k $, label.angle=-90}{b2}
					\fmfv{label=$ \tau_{k+1} $, label.angle=-90}{b4}
				\end{fmfgraph*}
        			\end{gathered}
			\quad \quad \rightarrow \quad \quad
		        	\begin{gathered}
				\begin{fmfgraph*}(40, 15)
					\fmfstraight
					\fmftop{t1,t2,t3,t4,t5}
					\fmfbottom{b1,b2,b3,b4,b5}
					\fmf{dots}{b1,b2}
					\fmf{fermion, label=$ \textcolor{highlight}{\vec p_k'} $, label.side=left}{b2,b4}
					\fmf{dots}{b4,b5}
					\fmf{dashes, foreground=(1,,0,,0), left=0.4}{b2,t4}
					\fmf{dashes, foreground=(0,,0,,1), right=0.4}{b4,t2}
					\fmfdot{b2,b4}
        					\Marrow{a}{left}{lft}{$ c_2 q_2 $}{b2,t3}{12}
        					\Marrow{b}{right}{rt}{$ c_1 q_1 $}{b4,t3}{12}
					\fmfv{label=$ \tau_k $, label.angle=-90}{b2}
					\fmfv{label=$ \tau_{k+1} $, label.angle=-90}{b4}
				\end{fmfgraph*}
        			\end{gathered}
		\end{equation*}
	\end{fmffile}
	\caption{The diagram structure is modified by interchanging the phonon propagators connected to two neighboring nodes. \todo{Bold face: $ \vec q_1 $ and $ \vec q_2 $}}
	\label{fig:NORMALcods}
\end{figure}


This update procedure, as illustrated in figure \ref{fig:NORMALcods}, interchange the two phonon propagators connected to a pair of randomly selected neighboring nodes. In order to conserve momentum, the $ \Gt_0 $ connected to both of the selected nodes must absorb the difference $ \vec p'_k - \vec p_k = c_1 \vec q_1 - c_2 \vec q_2 $. Here the $ c_i $ tells whether the propagator is propagating towards any of the two nodes ($ c_i = -1 $) or if it is propagating away from any of the two nodes ($ c_i = 1 $). The ratio of the diagram value prior to and after the update then becomes
\begin{equation}
	\begin{split}
		\frac{D_n(\xi'_n)}{D_n(\xi_n)}
		&= \frac{
			\Dt_0 (\vec q_1, c_1[\tau_i - \tau_{k+1}]) \, \Dt_0 (\vec q_2, c_2[\tau_j - \tau_k]) \, \Gt_0 (\vec p'_k, \tau_{k+1} - \tau_k)
		}{
			\Dt_0 (\vec q_1, c_1[\tau_i - \tau_k]) \, \Dt_0 (\vec q_2, c_2[\tau_j - \tau_{k+1}]) \, \Gt_0 (\vec p_k, \tau_{k+1} - \tau_k)
		} \\[4pt]
		&= \exp \left\{ -\left[ \frac{(\vec p_k + c_1 \vec q_1 - c_2 \vec q_2)^2}{2} - \frac{p_k^2}{2} - c_1 + c_2 \right] (\tau_{k+1} - \tau_k) \right\} \,.
	\end{split}
\end{equation}
Other than the pair of nodes to be picked, there are no parameters to be sampled in order to change the diagram structure in this way. Thus $ W(\xi_n|\xi'_n) = W(\xi'_n|\xi_n) $ and the update procedure should be accepted according to
\begin{equation}
	A(\xi_n|\xi'_n) = \min{1, \, \frac{D_n(\xi'_n)}{D_n(\xi_n)}} \,.
\end{equation}


\subsection*{Change of digram order}

\begin{figure}[H]
	\begin{fmffile}{NORMALchangeOfDiagramOrder}
		\begin{equation*}
		        	\begin{gathered}
				\begin{fmfgraph*}(40, 15)
					\fmfstraight
					\fmftop{t1,t2,t3,t4,t5,t6,t7,t8}
					\fmfbottom{b1,b2,b3,b4,b5,b6,b7,b8}
					\fmf{dots}{b1,b2}
					\fmf{fermion, label=$ \vec p_i $, label.side=left}{b2,b4}
					\fmf{dots}{b4,b5}
					\fmf{fermion, label=$ \vec p_j $, label.side=left}{b5,b7}
					\fmf{dots}{b7,b8}
					\fmf{dashes}{b2,v1}
					\fmf{phantom}{v1,t2}
					\fmf{dashes}{b4,v2}
					\fmf{phantom}{v2,t4}
					\fmf{dashes}{b5,v3}
					\fmf{phantom}{v3,t5}
					\fmf{dashes}{b7,v4}
					\fmf{phantom}{v4,t7}
					\fmfdot{b2,b4,b5,b7}
				\end{fmfgraph*}
        			\end{gathered}
			\quad \leftrightarrow \quad
		        	\begin{gathered}
				\begin{fmfgraph*}(60, 15)
					\fmfstraight
					\fmftop{t1,t2,t3,t4,t5,t6,t7,t8}
					\fmfbottom{b1,b2,b3,b4,b5,b6,b7,b8}
					\fmf{dots}{b1,b2}
					\fmf{fermion, label=$ \vec p_i $, label.side=left}{b2,b3}
					\fmf{fermion, label=$ \textcolor{highlight}{\vec p_i'} $, label.side=left}{b3,b4}
					\fmf{dots}{b4,b5}
					\fmf{fermion, label=$ \textcolor{highlight}{\vec p_j'} $, label.side=left}{b5,b6}
					\fmf{fermion, label=$ \vec p_j $, label.side=left}{b6,b7}
					\fmf{dots}{b7,b8}
					\fmf{dashes}{b2,v1}
					\fmf{phantom}{v1,t2}
					\fmf{dashes}{b4,v2}
					\fmf{phantom}{v2,t4}
					\fmf{dashes}{b5,v3}
					\fmf{phantom}{v3,t5}
					\fmf{dashes}{b7,v4}
					\fmf{phantom}{v4,t7}
					\fmf{dashes, left, foreground=(1,,0,,0), label=$ \textcolor{highlight}{\vec q_k} $}{b3,b6}
					\fmfdot{b2,b3,b4,b5,b6,b7}
					\fmfv{foreground=(1,,0,,0), label=$ \textcolor{highlight}{\tau_l} $, label.a=-90}{b3}
					\fmfv{foreground=(1,,0,,0), label=$ \textcolor{highlight}{\tau_m} $, label.a=-90}{b6}
				\end{fmfgraph*}
        			\end{gathered}
		\end{equation*}
	\end{fmffile}
	\caption{An illustration of the change of diagram order procedure.}
	\label{fig:NORMALcodo}
\end{figure}

This final update procedure which is illustrated in figure \ref{fig:NORMALcodo}, is the only one which changes the order of the diagram at hand. To increase the diagram order, an electronic propagator $ \Gt_{0, i} $ is selected on random and then split at a time $ \tau_l $, which is sampled uniformly on the interval $ [\tau_i, \, \tau_{i+1}] $. After this, another imaginary time $ \tau_m $ is sampled on the interval $ \tau_m \in[\tau_l, \tau] $ using an exponential distribution with a rate parameter $ \lambda = 1 $. The $ \Gt_{0,j} $ which happen to occupy the imaginary-time $ \tau_m $ is split in twice at that point as well. For each of the two times $ \tau_l $ and $ \tau_m $, a node is inserted so that the loose ends of the $ \Gt_0 $'s have something to connect to. The two newly introduced nodes are then further connected to a new phonon propagator $ \tilde \Dt_0 $, for which the momentum $ \vec q_k $ is sampled according to the \textit{change of transferred momentum} procedures introduced earlier. In order to obey momentum conservation at each node, the $ \Gt_0 $'s under the newly added phonon arc have their momentum subtracted by $ \vec q_k $. In this way, the probability distribution of increasing the diagram order becomes
\begin{equation}
	\begin{split}
		W(n|n+1)
		&=
		P_\text{R} \;
		\frac{1}{2n + 1} \frac{1}{\tau_{i+1}  - \tau_i} \;
		\frac{e^{- (\tau_m - \tau_l)}}{1 - e^{- (\tau - \tau_l)}} \;
		\frac{\sin \theta_k}{2} \frac{1}{2 \pi} \\[4pt]
		& \times \sqrt{\frac{2 (\tau_m - \tau_l)}{\pi}} \exp \left\{- \frac{q_k^2}{2} (\tau_m - \tau_l) \right\} \,.
	\end{split}
\end{equation}
Here $ P_\text{R}(n) $ is the probability of choosing to raise the diagram order once having selected the \textit{change of diagram order} procedure. Of course the corresponding probability of choosing to lower the diagram order is then nothing but $ 1 - P_\text{R}(n) $. Further more, the ratio of the diagram value prior to and after the update is realized to be
\begin{equation}
	\begin{split}
		\frac{D_{n+1}}{D_n}
		&= \tilde \Dt_0(\vec q_k, \tau_m - \tau_l) \,
		\frac{
			\prod \limits_{i=l}^{m-1} \Gt_0(\vec p_i - \vec q_k, \tau_{i + 1} - \tau_i)
		}{
			\prod \limits_{i=l}^{m-1} \Gt_0(\vec p_i, \tau_{i + 1} - \tau_i)
		} \\
		&= \frac{2 \sqrt 2 \pi \alpha}{(2\pi)^3} \, \sin \theta_k \, \exp \left\{ - \left[ \frac{q_k^2}{2} + 1 - \langle \vec p \rangle_{l,m-1} \cdot \vec q_k \right] (\tau_m - \tau_l) \right\} \,.
	\end{split}
\end{equation}

The procedure of lowering the diagram order is much more simplistic; it is only necessary to randomly pick a $ \tilde \Dt $ which is to be removed. Hence $ W(n+1|n) = (1 - P_\text{R}(n+1)) \, [n+1]^{-1} $, and by introducing the quantity
\begin{equation}
	\begin{split}
		R(n|n+1)
		&= \frac{D_{n+1}}{D_n} \frac{W(n+1|n)}{W(n|n+1)} \\[4pt]
		&=
		\frac{1 - P_\text{R}(n+1)}{P_\text{R}(n)}
		\frac{\alpha}{\sqrt \pi}
		\frac{2n + 1}{n+1}
		\frac{\tau_{i+1} - \tau_i}{\sqrt{\tau_m - \tau_l}} \\
		&\times \left[ 1 - e^{-(\tau - \tau_l)} \right]
		\exp \big\{ [\langle \vec p \rangle_{l,m-1} \cdot \vec q_k] (\tau_m - \tau_l) \big\} \,
	\end{split}
\end{equation}
the acceptance ratios may be expressed as
\begin{equation}
	A(n|n+1) = \min{1, \, R(n|n+1)}
	\; , \quad
	A(n+1|n) = \min{1, \, 1/R(n|n+1)} \,.
\end{equation}
By requiring that
\begin{equation}
	\frac{1 - P_\text{R}(n+1)}{P_\text{R}(n)} = \frac{\sqrt \pi}{2 \alpha}
	\quad \Rightarrow \quad
	P_\text{R}(n) = P_\text{R} = \left[ 1 + \frac{\sqrt \pi}{2 \alpha}\right]^{-1}
\end{equation}
these acceptance ratios become independent of the coupling constant $ \alpha $ and less dependent of the diagram order $ n $

Clearly it should not be possible to lower the diagram order any further than $ n=0 $. Also, one could think of implementing a maximum order $ n_\text{max} $ for which the diagram order 
should not be able to rise above. To achieve this, it is extremely important not to set $ P_\text{R} = 1 $ and $ P_\text{R} = 0 $ at $ n=0 $ and $ n=n_\text{max} $ respectively, since this would ruin the detailed balance. Rather one should approach this by simply refusing such an update. For example, if the procedure to increase the diagram order happen to be chosen when $ n = n_\text{max} $, it should be refused and a new update procedure chosen instead.

\begin{itemize}
	\item \todo{Check the acceptance ratio!\textbf{}}
\end{itemize}

\subsection{Results}

\begin{figure}[H]
	\centering
 	\includegraphics[width=\textwidth, ]{{"Images/Plots/Gt/Gt_p0_bare"}.pdf}
	\caption{The acquired value of $ \Gt(p = 0, \, \tau) $ after 80 minutes of core time using the chemical potential $ \mu = -1.1 $. Here $ \tau_{max} = 40 $ and $ \Delta \tau = 0.02 $.}
	\label{fig:GtOfP0}
\end{figure}

\begin{figure}[H]
	\centering
 	\includegraphics[width=\textwidth, ]{{"Images/Plots/Gt/Gt_p15_bare"}.pdf}
		\caption{The acquired value of $ \Gt(p = 1.5, \, \tau) $ after 80 minutes of core time using the chemical potential $ \mu = -0.25 $. Here $ \tau_{max} = 40 $ and $ \Delta \tau = 0.02 $.}
	\label{fig:GtOfP1.5}
\end{figure}

\begin{table}[H]
	\begin{center}
		\begin{tabular}{r | l | l} 
		 	$ \tau $ & $ \Gt(p = 0, \tau) $ & $ \Gt(p = 1.5, \tau) $ \\ 
		 	\specialrule{.1em}{.05em}{.05em} 
0.01 & 0.9905685 & 0.988137 \\
1.01 & 0.6241805 & 0.4938275 \\
2.01 & 0.522485 & 0.363129 \\
3.01 & 0.467273 & 0.306567 \\
4.01 & 0.425932 & 0.274499 \\
5.01 & 0.3907045 & 0.2528175 \\
6.01 & 0.359004 & 0.2364785 \\
7.01 & 0.3300515 & 0.2230085 \\
8.01 & 0.3041385 & 0.211315 \\
9.01 & 0.279727 & 0.200281 \\
10.01 & 0.257335 & 0.190181 \\
11.01 & 0.237363 & 0.180648 \\
12.01 & 0.2174565 & 0.171495 \\
13.01 & 0.2003495 & 0.163467 \\
14.01 & 0.1844085 & 0.155187 \\
15.01 & 0.169466 & 0.147606 \\
16.01 & 0.156047 & 0.140906 \\
17.01 & 0.143584 & 0.1340965 \\
18.01 & 0.131918 & 0.127592 \\
19.01 & 0.1213235 & 0.121574 \\
20.01 & 0.1116015 & 0.115719 \\
21.01 & 0.1025415 & 0.110319 \\
22.01 & 0.094341 & 0.105099 \\
23.01 & 0.0868875 & 0.099854 \\
24.01 & 0.079825 & 0.0952285 \\
25.01 & 0.0736285 & 0.090897 \\
26.01 & 0.067637 & 0.0865115 \\
27.01 & 0.0621675 & 0.082502 \\
28.01 & 0.057182 & 0.0784385 \\
29.01 & 0.052717 & 0.0747105 \\
30.01 & 0.048613 & 0.0710195 \\
31.01 & 0.044576 & 0.067424 \\
32.01 & 0.040984 & 0.0640415 \\
33.01 & 0.0379385 & 0.0613055 \\
34.01 & 0.0348165 & 0.0583585 \\
35.01 & 0.0319025 & 0.0552485 \\
36.01 & 0.0294495 & 0.052687 \\
37.01 & 0.0272275 & 0.050223 \\
38.01 & 0.025092 & 0.0478835 \\
39.01 & 0.022881 & 0.04576 \\
		\end{tabular}
	\end{center}
	\caption{\todo{caption this please!} \flaw{Less precision!}}
	\label{tab:truthTables}   
\end{table}

\begin{itemize}
	\item \todo{A samples of the Green's function at $ p = 0 $ and $ p = 1.5 $. There should also be a table with 10 or so values from these $ \Gt $'s}
\end{itemize}


\section{Bare scheme update procedures for $ \Sigma^* $}

\begin{itemize}
	\item \todo{Different type of increase/lower diagram order update procedure.}
	\item \todo{only proper self energy diagrams}
\end{itemize}

\subsection{Divergent diagram}

The first order proper self energy diagram is proportional to $ 1/\sqrt{\tau} $ for small $ \tau $ and thus diverges when $ \tau \rightarrow 0 $. This combined with a discretized histogram becomes a problem for the bins in the neighborhood of $ \tau = 0 $ since they acquire more mass then they are supposed to. In order to fix this we could use a much finer discretization or calculate the value for these bins somehow else.

The value of the diagram for $ \vec p = \vec 0 $ and $ \Delta G = 0 $ is

\begin{equation}
	S^{(1)}(\tau) = \frac{\alpha}{\sqrt{\pi \tau}} e^{(\mu - \omega)\tau}
\end{equation}

The value of the bins in our histogram is

\begin{equation}
	\tilde V_i \propto \frac{1}{\Delta \tau} \int_{\tau_i}^{\tau_{i + 1}} S^{(1)} (t) \diff t
	= \frac{\alpha}{\Delta \tau \sqrt{\omega - \mu}} \left[ \text{erf}\left(\sqrt{\omega - \mu} \sqrt{\tau_{i+1}}\right) - \text{erf}\left(\sqrt{\omega - \mu} \sqrt{\tau_i}\right) \right]
\end{equation}

 but the true value should be
 
\begin{equation}
	V_i \propto S^{(1)} \left( \tfrac{\tau_{i+1} + \tau_i}{2} \right)	
\end{equation}

For all bins which fulfil $ \tilde V_i  - V_i > \epsilon $ we instead of using DMC utilise ordinary stochastic integration using MC for the fixed times $ (\tau_{i+1} + \tau_i)/2 $.

\subsection{Results}



\section{Bold scheme \question{?}}

